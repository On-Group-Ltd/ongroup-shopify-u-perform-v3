{% comment %}
  Renders purchase options tabs for one-time purchase and subscription.
  Integrates with Recharge Subscriptions via selling plans.

  Accepts:
  - product: {Object} product object.
  - block: {Object} passing the block information (optional).

  Usage:
  {% render 'purchase-options-tabs', product: product %}

  Based on og-recharge-widget-v3.liquid logic
{% endcomment %}

{% assign debugMode = false %}
{% assign showPriceSavingNotPerc = true %}

{%- liquid
  assign current_variant = product.selected_or_first_available_variant | default: product.variants.first
  assign current_selling_plan_allocation = current_variant.selected_selling_plan_allocation
  if current_selling_plan_allocation == nil and current_variant.requires_selling_plan
    assign current_selling_plan_allocation = current_variant.selling_plan_allocations | first
  endif
  assign offer = current_selling_plan_allocation | default: current_variant
-%}

{% comment %}Build subscription options array{% endcomment %}
{% capture subslist %}
{%- for selling_plan_group in product.selling_plan_groups -%}
{%- for selling_plan in selling_plan_group.selling_plans -%}
    {%- liquid
        assign subdiscount = selling_plan.price_adjustments[0]
        assign is_discounted = false
          if subdiscount.value > 0
              assign is_discounted = true
          endif
        assign subprice = current_variant.selling_plan_allocations[0]
        assign sortid = 1000000 | plus: subprice.price

        assign subsaving = selling_plan.price_adjustments[0].value
        if showPriceSavingNotPerc
            assign subsaving = subprice.compare_at_price | minus: subprice.price
        endif

        assign selling_plan_name = selling_plan.name
        if product.metafields.info.subscription_description != blank
          assign selling_plan_name = product.metafields.info.subscription_description
        endif

        assign sub_product_overview = ''
        if product.metafields.info.subscription_overview != blank
          assign sub_product_overview = product.metafields.info.subscription_overview
        endif
    -%}
{{ sortid }}||{{ current_variant.id }}||{{ selling_plan.id }}||{{ selling_plan_name }}||||{{ subsaving }}||{{ subprice.compare_at_price }}||{{ subprice.price }}||{{ product.id }}||{{ sub_product_overview }} ::
{%- endfor -%}
{%- endfor -%}
{%- assign subProductHandles =  product.metafields.info.subscription_products | split:'|' -%}
{%- for subProdHandle in subProductHandles -%}
{%- liquid
  assign subex_product = all_products[subProdHandle]
  assign subex_variant = subex_product.selected_or_first_available_variant | default: subex_product.variants.first
  assign subprice = subex_variant.selling_plan_allocations[0]
-%}

    {%- for selling_plan_group in subex_product.selling_plan_groups -%}
        {%- for selling_plan in selling_plan_group.selling_plans -%}
            {%- liquid
                assign subdiscount = selling_plan.price_adjustments[0]
                assign is_discounted = false
                      if subdiscount.value > 0
                      assign is_discounted = true
                  endif
                assign subprice = subex_variant.selling_plan_allocations[0]

                assign calcprice = subprice
                assign calcdiscount = selling_plan.price_adjustments[0].value
                if subex_product.requires_selling_plan
                    assign calcprice = subex_variant
                    assign calcdiscount = calcprice.compare_at_price | minus: calcprice.price | times: 100.0 | divided_by: calcprice.compare_at_price | money_without_currency | times: 100 | remove: '.0'
                endif

                assign subsaving = calcdiscount
                if showPriceSavingNotPerc
                    assign subsaving = calcprice.compare_at_price | minus: calcprice.price
                endif

                assign sortid = 1000000 | plus: calcprice.price

                assign selling_plan_name = selling_plan.name
                if subex_product.metafields.info.subscription_description != blank
                  assign selling_plan_name = subex_product.metafields.info.subscription_description
                endif

                assign subex_product_overview = ''
                if subex_product.metafields.info.subscription_overview != blank
                  assign subex_product_overview = subex_product.metafields.info.subscription_overview
                endif
            -%}
{{ sortid }}||{{ subex_variant.id }}||{{ selling_plan.id }}||{{ selling_plan_name }}||{{ subex_product.description | strip | strip_html | truncate: 250 }}||{{ subsaving }}||{{ calcprice.compare_at_price }}||{{ calcprice.price }}||{{ subex_product.id }}||{{ subex_product_overview }} ::
        {%- endfor -%}
    {%- endfor -%}
{%- endfor -%}
{% endcapture %}
{% assign subsarray = subslist | strip_newlines | split: '::' | sort %}

{%- liquid
  assign current_selected_option = ''
  if product.metafields.info.preselected_product_variant != blank
    assign current_selected_option = product.metafields.info.preselected_product_variant | split: ':' | last | plus: 0
  endif
  assign subsarray = subsarray | reverse
-%}

<style>
  .purchase-options-tabs {
    margin-bottom: 1.5rem;
  }

  .purchase-tabs {
    display: flex;
    gap: 0;
    border-bottom: 2px solid rgba(var(--color-foreground), 0.1);
    margin-bottom: 1rem;
  }

  .purchase-tab {
    flex: 1;
    padding: 1rem;
    background: none;
    border: none;
    border-bottom: 2px solid transparent;
    margin-bottom: -2px;
    cursor: pointer;
    font-size: 1.4rem;
    font-weight: 500;
    color: rgba(var(--color-foreground), 0.7);
    transition: all 0.2s ease;
    text-align: center;
  }

  .purchase-tab:hover {
    color: rgb(var(--color-foreground));
    background: rgba(var(--color-foreground), 0.02);
  }

  .purchase-tab.active {
    color: rgb(var(--color-foreground));
    border-bottom-color: rgb(var(--color-foreground));
  }

  .purchase-tab-content {
    display: none;
    animation: fadeIn 0.3s ease;
  }

  .purchase-tab-content.active {
    display: block;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .purchase-option-details {
    padding: 1.5rem;
    background: rgba(var(--color-foreground), 0.02);
    border-radius: 0.5rem;
  }

  .purchase-option-title {
    font-size: 1.6rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
  }

  .purchase-option-description {
    font-size: 1.4rem;
    color: rgba(var(--color-foreground), 0.7);
    margin-bottom: 1rem;
    line-height: 1.5;
  }

  .purchase-option-price {
    font-size: 1.8rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
  }

  .purchase-option-savings {
    display: inline-block;
    padding: 0.4rem 0.8rem;
    background: rgba(var(--color-foreground), 0.1);
    border-radius: 0.3rem;
    font-size: 1.2rem;
    font-weight: 500;
    color: rgb(var(--color-foreground));
  }

  .subscription-frequency {
    margin-top: 1rem;
  }

  .subscription-frequency label {
    display: block;
    font-size: 1.4rem;
    font-weight: 500;
    margin-bottom: 0.5rem;
  }

  .subscription-frequency select {
    width: 100%;
    padding: 1rem;
    font-size: 1.4rem;
    border: 1px solid rgba(var(--color-foreground), 0.2);
    border-radius: 0.5rem;
    background: rgb(var(--color-background));
    color: rgb(var(--color-foreground));
  }

  .recharge-subscription-widget {
    margin-top: 1rem;
  }

  .subscription-options-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .subscription-option-item {
    padding: 1rem;
    border: 2px solid rgba(var(--color-foreground), 0.1);
    border-radius: 0.5rem;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .subscription-option-item:hover {
    border-color: rgba(var(--color-foreground), 0.3);
    background: rgba(var(--color-foreground), 0.02);
  }

  .subscription-option-item.selected {
    border-color: rgb(var(--color-foreground));
    background: rgba(var(--color-foreground), 0.05);
  }

  .subscription-option-item input[type="radio"] {
    position: absolute;
    opacity: 0;
    pointer-events: none;
  }

  .subscription-option-label {
    display: flex;
    align-items: center;
    justify-content: space-between;
    cursor: pointer;
  }

  .subscription-option-name {
    font-weight: 500;
    font-size: 1.4rem;
  }

  .subscription-option-overview {
    margin-top: 0.5rem;
    font-size: 1.3rem;
    color: rgba(var(--color-foreground), 0.7);
    line-height: 1.5;
  }
</style>

{%- liquid
  assign subscription_tab_title = 'Subscribe & Save'
  if subsarray.size > 0
    assign first_subopt = subsarray | first
    assign first_subdata = first_subopt | split: "||"
    if first_subdata[3] != blank
      assign subscription_tab_title = first_subdata[3]
    endif
  endif
-%}

<div class="purchase-options-tabs" {{ block.shopify_attributes }} data-section-id="{{ section.id }}">
  <div class="purchase-tabs" role="tablist">
    {%- unless product.requires_selling_plan -%}
    <button
      class="purchase-tab {% if current_selected_option == '' %}active{% endif %}"
      role="tab"
      aria-selected="{% if current_selected_option == '' %}true{% else %}false{% endif %}"
      aria-controls="one-time-purchase"
      data-tab="one-time"
      type="button"
    >
      One-Time Purchase
    </button>
    {%- endunless -%}
    <button
      class="purchase-tab {% if product.requires_selling_plan or current_selected_option != '' %}active{% endif %}"
      role="tab"
      aria-selected="{% if product.requires_selling_plan or current_selected_option != '' %}true{% else %}false{% endif %}"
      aria-controls="subscription-purchase"
      data-tab="subscription"
      type="button"
    >
      {{ subscription_tab_title }}
    </button>
  </div>

  {%- unless product.requires_selling_plan -%}
  <div
    id="one-time-purchase"
    class="purchase-tab-content {% if current_selected_option == '' %}active{% endif %}"
    role="tabpanel"
    data-content="one-time"
  >
    <div class="purchase-option-details">
      <h3 class="purchase-option-title">One-Time Purchase</h3>
      <p class="purchase-option-description">
        Purchase this product once at the regular price.
      </p>
      <div class="purchase-option-price">
        {{ offer.price | money }}
      </div>
      <input type="radio"
        name="purchase-option"
        id="purchase-option-onetime"
        class="visually-hidden"
        data-purchase-type="one-time"
        data-variant-id="{{ current_variant.id }}"
        data-compare-price="{{ offer.compare_at_price | money }}"
        data-final-price="{{ offer.price | money }}"
        {% if current_selected_option == '' %}checked="checked"{% endif %}
      />
    </div>
  </div>
  {%- endunless -%}

  <div
    id="subscription-purchase"
    class="purchase-tab-content {% if product.requires_selling_plan or current_selected_option != '' %}active{% endif %}"
    role="tabpanel"
    data-content="subscription"
  >
    <div class="purchase-option-details">
      <h3 class="purchase-option-title">Subscribe & Save</h3>
      <p class="purchase-option-description">
        Never run out! Get this product delivered regularly and save.
      </p>

      {%- if subsarray.size > 0 -%}
      <div class="subscription-options-list">
        {%- assign optnum = 1 -%}
        {%- for subopt in subsarray -%}
          {%- assign subdata = subopt | split: "||" -%}
          <div class="subscription-option-item {% if product.requires_selling_plan and optnum == 1 %}selected{% elsif current_selected_option == current_variant.id %}selected{% endif %}">
            <input type="radio"
              name="purchase-option"
              id="purchase-option-sub-{{ optnum }}"
              class="visually-hidden"
              data-purchase-type="subscription"
              data-variant-id="{{ subdata[1] }}"
              data-selling-plan-id="{{ subdata[2] }}"
              data-compare-price="{{ subdata[6] | money }}"
              data-final-price="{{ subdata[7] | money }}"
              data-savings="{{ subdata[5] | money }}"
              {%- if product.requires_selling_plan -%}
                {%- if optnum == 1 -%}
                  checked="checked"
                {%- endif -%}
              {% elsif current_selected_option == current_variant.id %}checked="checked"
              {%- endif -%}
            />
            <label for="purchase-option-sub-{{ optnum }}" class="subscription-option-label">
              <div>
                <div class="subscription-option-name">{{ subdata[3] }}</div>
                {%- if subdata[9] != blank -%}
                <div class="subscription-option-overview">{{ subdata[9] }}</div>
                {%- endif -%}
              </div>
              <div class="purchase-option-price">
                {{ subdata[7] | money }}
                {%- if subdata[5] != blank and subdata[5] != '0' -%}
                <span class="purchase-option-savings">Save {{ subdata[5] | money }}</span>
                {%- endif -%}
              </div>
            </label>
          </div>
          {%- assign optnum = optnum | plus: 1 -%}
        {%- endfor -%}
      </div>
      {%- else -%}
      <p>No subscription options available for this product.</p>
      {%- endif -%}
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const purchaseTabsContainer = document.querySelector('.purchase-options-tabs');
  if (!purchaseTabsContainer) return;

  const sectionId = purchaseTabsContainer.dataset.sectionId;
  const productAddForm = document.querySelector(`FORM#product-form-${sectionId}`);
  const priceField = document.querySelector(`.price-${sectionId}`);
  const qtyField = document.querySelector(`#Quantity-${sectionId}`);
  const tabs = purchaseTabsContainer.querySelectorAll('.purchase-tab');
  const contents = purchaseTabsContainer.querySelectorAll('.purchase-tab-content');
  const allOptions = purchaseTabsContainer.querySelectorAll('input[name="purchase-option"]');
  const subscriptionItems = purchaseTabsContainer.querySelectorAll('.subscription-option-item');

  // Tab switching
  tabs.forEach(tab => {
    tab.addEventListener('click', () => switchTab(tab));
  });

  function switchTab(selectedTab) {
    const tabType = selectedTab.dataset.tab;

    // Update tabs
    tabs.forEach(tab => {
      const isSelected = tab === selectedTab;
      tab.classList.toggle('active', isSelected);
      tab.setAttribute('aria-selected', isSelected);
    });

    // Update content
    contents.forEach(content => {
      const isActive = content.dataset.content === tabType;
      content.classList.toggle('active', isActive);
    });

    // Select the appropriate radio option when switching tabs
    if (tabType === 'one-time') {
      const oneTimeOption = purchaseTabsContainer.querySelector('input[data-purchase-type="one-time"]');
      if (oneTimeOption) {
        oneTimeOption.checked = true;
        updateForm();
        updatePrice();
      }
    } else if (tabType === 'subscription') {
      const firstSubOption = purchaseTabsContainer.querySelector('input[data-purchase-type="subscription"]');
      if (firstSubOption) {
        firstSubOption.checked = true;
        updateForm();
        updatePrice();
      }
    }
  }

  // Handle radio option changes
  allOptions.forEach(option => {
    option.addEventListener('change', (e) => {
      updateForm();
      updatePrice();

      // Update visual selection state for subscription items
      subscriptionItems.forEach(item => {
        const radio = item.querySelector('input[type="radio"]');
        if (radio.checked) {
          item.classList.add('selected');
        } else {
          item.classList.remove('selected');
        }
      });
    });
  });

  // Handle subscription item clicks
  subscriptionItems.forEach(item => {
    item.addEventListener('click', (e) => {
      // Don't trigger if clicking the label directly (it will handle the radio)
      if (e.target.tagName === 'LABEL' || e.target.closest('label')) return;

      const radio = item.querySelector('input[type="radio"]');
      if (radio) {
        radio.checked = true;
        radio.dispatchEvent(new Event('change'));
      }
    });
  });

  function updatePrice() {
    const optSel = purchaseTabsContainer.querySelector('input[name="purchase-option"]:checked');
    if (!optSel || !priceField) return;

    const comparePrice = optSel.dataset.comparePrice;
    const finalPrice = optSel.dataset.finalPrice;
    const savings = optSel.dataset.savings;

    const priceDetails = priceField.querySelector('.price-item__details');
    const savingsElement = priceField.querySelector('.price-item__savings');

    // Update price in the add to cart button
    if (productAddForm) {
      const productFormPrice = productAddForm.querySelector('SPAN.product-form__price');
      if (productFormPrice) {
        productFormPrice.textContent = `- ${finalPrice}`;
      }
    }

    if (comparePrice !== undefined && finalPrice !== undefined) {
      if (comparePrice !== finalPrice && comparePrice !== '') {
        priceField.classList.add('price--on-sale');
        const saleBadge = priceField.querySelector('.price__badge-sale');
        if (saleBadge) saleBadge.style.display = 'none';

        const salePrice = priceField.querySelector('.price-item--sale');
        if (salePrice) salePrice.textContent = finalPrice;

        priceField.querySelectorAll('.price-item--regular').forEach(element => {
          element.textContent = comparePrice;
        });

        if (savingsElement) {
          savingsElement.textContent = "";
          if (savings && savings !== '$0.00' && savings !== 'Â£0.00') {
            savingsElement.textContent = `SAVE ${savings}`;

            if (priceDetails) {
              priceDetails.textContent = '*Subscribe to SAVE on every single order!';
            }
          } else {
            if (priceDetails) {
              priceDetails.textContent = "";
            }
          }
        }
      } else {
        priceField.classList.remove('price--on-sale');
        priceField.querySelectorAll('.price-item--regular').forEach(element => {
          element.textContent = finalPrice;
        });

        if (priceDetails) {
          priceDetails.textContent = '';
        }
        if (savingsElement) {
          savingsElement.textContent = '';
        }
      }
    }
  }

  function updateForm() {
    if (!productAddForm) return;

    const optSel = purchaseTabsContainer.querySelector('input[name="purchase-option"]:checked');
    if (!optSel) return;

    const variantIdInput = productAddForm.querySelector('INPUT[name="id"]');
    if (variantIdInput) {
      variantIdInput.value = optSel.dataset.variantId;
    }

    // Remove the old selling_plan (if it exists)
    const sellingPlanInput = productAddForm.querySelector('INPUT[name="selling_plan"]');
    if (sellingPlanInput) {
      sellingPlanInput.remove();
    }

    const sellingPlanId = optSel.dataset.sellingPlanId;
    const purchaseType = optSel.dataset.purchaseType;

    if (purchaseType === 'subscription' && sellingPlanId) {
      const productOptions = productAddForm.querySelector('DIV.product-options');
      if (productOptions) {
        productOptions.insertAdjacentHTML('beforeend', `<input name="selling_plan" value="${sellingPlanId}" type="hidden">`);
      }

      // Hide payment options for subscriptions
      document.querySelectorAll('klarna-placement, afterpay-placement, square-placement').forEach(el => el.classList.add('hidden'));
    } else {
      // Show payment options for one-time purchases
      document.querySelectorAll('klarna-placement, afterpay-placement, square-placement').forEach(el => el.classList.remove('hidden'));
    }

    // Dispatch event for other integrations
    document.dispatchEvent(new CustomEvent('purchase-type:change', {
      detail: {
        type: purchaseType,
        variantId: optSel.dataset.variantId,
        sellingPlanId: sellingPlanId
      }
    }));
  }

  // Initialize price and form based on currently selected option
  updatePrice();
  updateForm();

  // Set initial selected state for subscription items
  subscriptionItems.forEach(item => {
    const radio = item.querySelector('input[type="radio"]');
    if (radio && radio.checked) {
      item.classList.add('selected');
    }
  });
});
</script>
