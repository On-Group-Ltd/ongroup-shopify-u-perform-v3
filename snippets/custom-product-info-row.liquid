{% comment %}
  Renders custom product info row with quantity, add to cart button (with price), and installment message
  Accepts:
  - product: {Object} product object.
  - section_id: {String} id of section to which this snippet belongs.
  - product_form_id: {String} product form id.
  - show_installment: {Boolean} whether to show installment message (optional, default: true).

  Usage:
  {% render 'custom-product-info-row', product: product, section_id: section.id, product_form_id: product_form_id, show_installment: true %}
{% endcomment %}

{%- liquid
  assign show_installment = show_installment | default: true
  assign cart_qty = cart | item_count_for_variant: product.selected_or_first_available_variant.id

  assign check_against_inventory = true
  if product.selected_or_first_available_variant.inventory_management != 'shopify' or product.selected_or_first_available_variant.inventory_policy == 'continue'
    assign check_against_inventory = false
  endif
  if product.selected_or_first_available_variant.quantity_rule.min > product.selected_or_first_available_variant.inventory_quantity and check_against_inventory
    assign quantity_rule_soldout = true
  endif
-%}

<div class="custom-product-info-row">
  <product-form
    class="custom-product-form"
    data-section-id="{{ section_id }}"
  >
    <div class="product-form__error-message-wrapper" role="alert" hidden>
      <span class="svg-wrapper">
        {{- 'icon-error.svg' | inline_asset_content -}}
      </span>
      <span class="product-form__error-message"></span>
    </div>

    {%- form 'product',
      product,
      id: product_form_id,
      class: 'form custom-product-form-grid',
      novalidate: 'novalidate',
      data-type: 'add-to-cart-form'
    -%}
      <input
        type="hidden"
        name="id"
        value="{{ product.selected_or_first_available_variant.id }}"
        {% if product.selected_or_first_available_variant.available == false
          or quantity_rule_soldout
          or product.selected_or_first_available_variant == null
        %}
          disabled
        {% endif %}
        class="product-variant-id"
      >

      {%- comment -%} Quantity Selector - Dropdown {%- endcomment -%}
      <div class="custom-product-quantity">
        <label class="quantity__label form__label" for="Quantity-{{ section_id }}">
          <span>{{ 'products.product.quantity.label' | t }}</span>
        </label>
        <div class="quantity-dropdown-wrapper">
          <select
            class="quantity__select"
            name="quantity"
            id="Quantity-{{ section_id }}"
            form="{{ product_form_id }}"
          >
            {%- for i in (1..10) -%}
              <option value="{{ i }}" {% if i == 1 %}selected{% endif %}>{{ i }}</option>
            {%- endfor -%}
          </select>
        </div>
      </div>

      {%- comment -%} Add to Cart Button with Price {%- endcomment -%}
      <div class="custom-product-button">
        <button
          id="CustomProductSubmit-{{ section_id }}"
          type="submit"
          name="add"
          class="custom-add-to-cart-button button button--primary"
          {% if product.selected_or_first_available_variant.available == false
            or quantity_rule_soldout
            or product.selected_or_first_available_variant == null
          %}
            disabled
          {% endif %}
        >
          <span class="button-text">
            {%- if product.selected_or_first_available_variant == null -%}
              {{ 'products.product.unavailable' | t }}
            {%- elsif product.selected_or_first_available_variant.available == false or quantity_rule_soldout -%}
              {{ 'products.product.sold_out' | t }}
            {%- else -%}
              <span class="button-label">{{ 'products.product.add_to_cart' | t }}</span>
              <span class="button-price">{{ product.selected_or_first_available_variant.price | money }}</span>
            {%- endif -%}
          </span>
          {%- render 'loading-spinner' -%}
        </button>
      </div>

      {%- comment -%} Installment Message {%- endcomment -%}
      {%- if show_installment -%}
        <div class="custom-product-installment">
          {%- assign installment_form_id = 'custom-installment-' | append: section_id -%}
          {%- form 'product', product, id: installment_form_id, class: 'installment-form' -%}
            <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">
            <div class="installment-message">
              {{ form | payment_terms }}
            </div>
          {%- endform -%}
        </div>
      {%- endif -%}
    {%- endform -%}
  </product-form>
</div>
